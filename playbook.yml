---

- name: Configure Ansible controller for this specific scenario
  hosts: localhost
  become: yes
  become_user: root
  #The vault file stores the passwords in an encrypted format
  vars_files:
    /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
  roles:
    # The scenarioInit role set-up the iventory with the hosts defined in the Scenario template generated by CITEF
    - scenarioInit
  tags: init

- name: Configure DNS Srv
  hosts: DNS_SRV
  gather_facts: no
  become: yes
  become_user: root
  vars_files:
      - /etc/ansible/host_vars/vault_vars.yml
      - vars/dns-setup.yml        # Contains the configuration
  vars:
    ansible_become_pass: '{{ become_p }}'
    gophish_ip: "{{ hostvars.GOPHISH.vm.nics | getUserLayerIP }}"
    mail_ip: "{{ hostvars.MODOBOA.vm.nics | getUserLayerIP }}"
    dns_ip: "{{ hostvars.DNS_SRV.vm.nics | getUserLayerIP }}"
  tasks:
    - include_tasks: tasks/config-dns.yml
  tags: config-dns

- name: Configure ssl in Email_Srv
  hosts: MODOBOA
  gather_facts: no
  become: yes
  become_user: root
  vars_files:
      /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
  roles:
    - modoboa-ssl
  tags: email-ssl

- name: Configure Email_Srv
  hosts: MODOBOA
  connection: local
  become: yes
  become_user: root
  vars_files:
      /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
    api_token: '329d1d9c311debe9f781aa4e6765b431f7abc30c'
    configAction: 'configure'
    mail_srv_ip: '{{ hostvars.MODOBOA.ansible_host }}'
    domainsAndAccounts: "{{ hostvars.MODOBOA.vm.configuration.domainsAndAccounts }}"
    domain: 'mail.modoboa.int'
    mail_srv_url: 'https://{{ domain }}'
    api_url_base: '{{ mail_srv_url }}/api/v1/'
  roles:
    - modoboa-config
  tags: email-config

- name: Configure Pierre's Email preferences
  hosts: MODOBOA
  gather_facts: yes
  become: yes
  become_user: root
  vars_files:
      /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
  tasks:
    - include_tasks: tasks/modoboa-user-preferences.yml
  tags: email-user-prefs

- name: Configure Gophish
  hosts: GOPHISH
  connection: local
  become: yes
  become_user: root
  vars_files:
      /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
    gophish_admin_username: 'admin'
    gophish_admin_password: 'gophish'
    gophish_srv_ip: "{{ hostvars.GOPHISH.ansible_host }}"
    gophish_srv_port: "3333"
    srv_url: 'https://gophish:3333/'
    api_url_base: 'https://gophish:3333/api/'
    configAction: 'configure'
    sProfFile: 'files/gophish/sendingProfiles_cw-phishing.json'
    eTemplFile: 'files/gophish/emailTemplates_cw-phishing.json'
    lPagesFile: 'files/gophish/landingPages_cw-phishing.json'
    groupsFile: 'files/gophish/groups_cw-phishing.json'
    campaingsFile: 'files/gophish/campaigns_cw-phishing.json'
  roles:
    - "gophish-config"
  tags: config-gophish

- name: Prepare Trainee Workstation
  hosts: KALI
  gather_facts: no
  become: yes
  become_user: root
  vars_files:
      /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
  roles:
    - config-trainee
  tags: trainee

- name: Configure RHEA root CA on Linux
  hosts: CA_LINUX
  become: yes
  become_user: root
  vars_files:
      /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
  tasks:
    - include_tasks: tasks/config-ca-linux.yml
  tags: STUDENT

- name: Configure RHEA root CA on Windows
  hosts: CA_WIN
  tasks:
    - include_tasks: tasks/config-ca-windows.yml
  tags: win

- name: Configue DMZ Srv
  hosts: DMZ_SRV
  become: yes
  become_user: root
  vars_files:
      /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
  roles:
    - dmz-srv
  tags: dmz

- name: Change WIN_WKS hostame
  #Hostname is auto-generated from the 'name' field registered in the Configuration of the Asset in CITEF
  hosts: WIN_WKS
  gather_facts: no
  vars:
    hostname: 'WIN-WKS'
  roles:
    - win-hostname
  tags: [ win-hostname]

- name: Change SCADA_OPERATOR hostname
  #Hostname is auto-generated from the 'name' field registered in the Configuration of the Asset in CITEF
  hosts: SCADA_OPERATOR
  gather_facts: no
  vars:
    hostname: 'SCADA-OPERATOR'
  roles:
    - win-hostname
  tags: [ win-hostname]

- name: Set-up Palo Alto VM50
  hosts: VM50
  gather_facts: no
  roles:
    - PA-VM50
  tags: [ vm50 ]

- name: Configure Splunk server
  hosts: SPLUNK
  become: yes
  become_user: root
  gather_facts: no
  roles:
    config-splunk
  tags: [ splunk, splunk-srv ]

  - name: Configure Splunk forwarders on Linux
    hosts: DMZ_SRV
    become: yes
    become_user: root
    gather_facts: no
    roles:
      linux-splunk-fw
    tags: [ splunk, splunk-fw, splunk-fw-win ]

  - name: Configure Splunk forwarders on Windows
    hosts: WKS1,WKS2,WIN_SRV
    become: yes
    become_user: root
    gather_facts: no
    roles:
      win-splunk-fw
    tags: [ splunk, splunk-fw, splunk-fw-linux ]

  - name: Set-up Active Directory forest and domain controller
    #Hostname is auto-generated from the 'name' field registered in the Configuration of the Asset in CITEF
    hosts: WIN_SRV
    gather_facts: no
    roles:
      - AD-DC
    tags: [ ad, ad-dc]
