---

- name: Configure Ansible controller for this specific scenario
  hosts: localhost
  become: yes
  become_user: root
  #The vault file stores the passwords in an encrypted format
  vars_files:
    /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
  roles:
    # The scenarioInit role set-up the iventory with the hosts defined in the Scenario template generated by CITEF
    - scenarioInit
  tags: init

- name: Configure domain controller
  #Hostname is auto-generated from the 'name' field registered in the Configuration of the Asset in CITEF
  hosts: WIN_SRV
  vars:
    ansible_user: 'env-admin@myorg.com'
  vars_prompt:
    - name: "ansible_password"
      prompt: 'New domain password for env-admin ?'
      default: 'admin-env2'
  tasks:
    - name: "Export domain_pass"
      set_fact:
        domain_pass: "{{ ansible_password }}"

    - name: "Create the OU needed"
      win_domain_ou:
        name: "{{ item }}"
        path:  "dc=myorg,dc=com"
        protected: true
      loop:
        - directors
        - employees
        - workstations

    - name: Ensure the group scada_operators exists
      win_domain_group:
        name: scada_operators
        scope: global
        path: OU=employees,DC=myorg,DC=com

    - name: Ensure the group executives exists
      win_domain_group:
        name: executives
        scope: global
        path: OU=directors,DC=myorg,DC=com

    - name: Ensure user Jack is present
      win_domain_user:
        name: jboss
        firstname: Jack
        surname: Boss
        password: 'user-pass123!'
        password_never_expires: yes
        state: present
        path: ou=directors,dc=myorg,dc=com
        groups:
          - executives

    - name: Ensure user Luc is present
      win_domain_user:
        name: lscada
        firstname: Luc
        surname: Scada
        password: 'user-pass123!'
        password_never_expires: yes
        state: present
        path: ou=employees,dc=myorg,dc=com
        groups:
          - scada_operators

- name: Add Workstations to DC
  hosts: WIN_WKS,SCADA_OPERATOR
  gather_facts: no
  roles:
    - AD-registerWKS
  tags: [ ad-registerwks ]
