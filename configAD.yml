---

- name: Configure Ansible controller for this specific scenario
  hosts: localhost
  become: yes
  become_user: root
  #The vault file stores the passwords in an encrypted format
  vars_files:
    /etc/ansible/host_vars/vault_vars.yml
  vars:
    ansible_become_pass: '{{ become_p }}'
  roles:
    # The scenarioInit role set-up the iventory with the hosts defined in the Scenario template generated by CITEF
    - scenarioInit
  tags: init

- name: Configure domain controller
  #Hostname is auto-generated from the 'name' field registered in the Configuration of the Asset in CITEF
  hosts: WIN_SRV
  vars:
    ansible_user: 'env-admin@myorg.com'
  vars_prompt:
    - name: "ansible_password"
      prompt: 'New domain password for env-admin ?'
      default: 'admin-env2'
  tasks:
    - name: "Export domain_pass"
      set_fact:
        domain_pass: "{{ ansible_password }}"

    - name: "Create the OU needed"
      win_domain_ou:
        name: "{{ item }}"
        path:  "dc=myorg,dc=com"
        protected: true
      loop:
        - directors
        - employees
        - workstations

    - name: Ensure the group scada_operators exists
      win_domain_group:
        name: scada_operators
        scope: global
        path: OU=employees,DC=myorg,DC=com

    - name: Ensure the group executives exists
      win_domain_group:
        name: executives
        scope: global
        path: OU=directors,DC=myorg,DC=com

    - name: Ensure user Jack is present
      win_domain_user:
        name: jboss
        firstname: Jack
        surname: Boss
        password: 'user-pass123!'
        password_never_expires: yes
        state: present
        path: ou=directors,dc=myorg,dc=com
        groups:
          - executives
          - "Remote Desktop Users"

    - name: Ensure user Luc is present
      win_domain_user:
        name: lscada
        firstname: Luc
        surname: Scada
        password: 'user-pass123!'
        password_never_expires: yes
        state: present
        path: ou=employees,dc=myorg,dc=com
        groups:
          - scada_operators
          - "Remote Desktop Users"

    - name: Ensure user dc-admin is present
      win_domain_user:
        name: dc-admin
        password: '!@Admin!@'
        password_never_expires: yes
        state: present
        path: ou=employees,dc=myorg,dc=com
        groups:
          - "Administrators"
          - "Domain Admins"
          - "Domain Users"
          - "Enterprise Admins"
          - "Group Policy Creator Owners"
          - "Schema Admins"
          - "Remote Desktop Users"

    - name: Ensure user webadmin is present
      win_domain_user:
        name: webadmin
        password: 'badm1nt0n!'
        password_never_expires: yes
        state: present
        path: ou=employees,dc=myorg,dc=com
        groups:
          - "Domain Users"
          - "Remote Desktop Users"

    - name: Set Internal DNS Zone for besthostingever.com
      community.windows.win_dns_zone:
        name: besthostingever.com
        type: primary
        replication: "domain"

    - name: Set www DNS record for besthostingever.com
      community.windows.win_dns_record:
        zone: besthostingever.com
        type: "A"
        name: "@"
        value: "100.10.40.2"

- name: Add Workstations to DC
  hosts: WKS1,WKS2
  gather_facts: no
  roles:
    - AD-registerWKS
  tags: [ ad-registerwks ]
